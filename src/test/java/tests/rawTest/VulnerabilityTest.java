package tests.rawTest;

import io.restassured.response.Response;
import org.junit.jupiter.api.Order;
import org.junit.jupiter.api.Test;

import static io.restassured.RestAssured.given;
import static io.restassured.RestAssured.when;

public class VulnerabilityTest {
    @Test
    @Order(2)
    public void scannerVulnerabilityTest(){
        //START SCAN
        Response response = given()
                .queryParam("url", "http://todo.ly")
                .log().all()
        .when()
                .get("http://127.0.0.1:9292/JSON/ascan/action/scan/");

        response.then().log().all();
        String idScan = response.then().extract().path("scan");

        //SCAN STATE
        String status = "0";
        do {
            try {
                Thread.sleep(5000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            response = given()
                    .queryParam("scanId", idScan)
                    .log().all()
                    .when()
                    .get("http://127.0.0.1:9292/JSON/ascan/view/status/");
            response.then().log().all();
            status = response.then().extract().path("status");
        }
        while(!status.equals("100"));

        //GET VULNERABILITIES
        response = given()
                .queryParam("scanId", idScan)
                .log().all()
                .when()
                .get("http://127.0.0.1:9292/JSON/ascan/view/scanProgress/");

        response.then().log().all();

        //MAKE REPORT
        response = given()
                .log().all()
                .when()
                .get("http://127.0.0.1:9292/OTHER/core/other/htmlreport/");

        response.then().log().all();
    }
}
